<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Testing </title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* (styles unchanged) */
    :root { /* ... */ }
    /* ... rest of CSS ... */
  </style>
</head>

<body>
  <!-- Dashboard Page -->
  <div id="dashboardPage">
    <aside class="sidebar">
      <button class="new-folder" onclick="showCreateFolderModal()">
        <span class="icon"><i class="fas fa-folder-plus"></i></span>
        <span>Make a folder</span>
      </button>
      <div class="nav-item">
        <span class="icon"><i class="fas fa-home"></i></span><span>Home</span>
      </div>
      <div class="nav-item active" onclick="showMyDrive()">
        <span class="icon"><i class="fas fa-hdd"></i></span><span>My Drive</span>
      </div>
      <div class="nav-item">
        <span class="icon"><i class="fas fa-user-friends"></i></span><span>Shared with me</span>
      </div>
    </aside>
    <main class="main-content">
      <div class="folder-grid" id="folderGrid">
        <!-- Dashboard: folder thumbnails -->
      </div>
    </main>

    <!-- Create Folder Modal -->
    <div class="modal" id="createFolderModal">
      <div class="modal-content">
        <div class="modal-title">Create new folder</div>
        <input type="text" class="modal-input" id="folderNameInput" placeholder="Folder name">
        <div class="modal-buttons">
          <button class="modal-button cancel" onclick="hideCreateFolderModal()">Cancel</button>
          <button class="modal-button create" onclick="createFolder()">Create</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Folder View Page -->
  <div id="folderPage" style="display:none; flex-direction: column; min-height:100vh;">
    <section class="section">
      <div class="container">
        <div class="content-box">
          <button class="button is-light mb-4" onclick="backToDashboard()">
            <span class="icon"><i class="fas fa-arrow-left"></i></span>
            <span>Back to Dashboard</span>
          </button>
          <h1 class="title is-3 has-text-primary">
            <i class="fas fa-folder-open mr-2"></i> Folder Contents
          </h1>
          <p class="subtitle is-6 has-text-grey">
            Folder ID: <span id="folderId" class="has-text-weight-bold"></span>
          </p>

          <div class="drop-zone" id="dropZone">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
            <p class="is-size-5 mb-2">Drag & drop files here</p>
            <p class="is-size-7 has-text-grey">or</p>
            <div class="file has-name is-centered my-3">
              <label class="file-label">
                <input class="file-input" type="file" id="fileInput" name="file">
                <span class="file-cta">
                  <span class="file-icon"><i class="fas fa-upload"></i></span>
                  <span class="file-label">Choose a file…</span>
                </span>
                <span class="file-name" id="fileName">No file selected</span>
              </label>
            </div>
            <button class="button is-primary is-small" id="uploadButton" disabled>
              <span class="icon"><i class="fas fa-upload"></i></span>
              <span>Upload</span>
            </button>
            <div class="progress-container" id="progressContainer">
              <progress class="progress is-primary" id="uploadProgress" value="0" max="100"></progress>
              <p class="has-text-centered is-size-7 has-text-grey" id="progressText">0%</p>
            </div>
          </div>

          <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
            <h2 class="title is-5">Files</h2>
            <div class="field has-addons">
              <div class="control">
                <input class="input is-small" type="text" id="searchInput" placeholder="Search files...">
              </div>
              <div class="control">
                <button class="button is-primary is-small" id="refreshButton">
                  <span class="icon"><i class="fas fa-sync-alt"></i></span>
                </button>
              </div>
            </div>
          </div>

          <div id="loadingSpinner" class="loading-spinner my-5"></div>
          <div id="folderContents" class="mb-4"></div>
        </div>
      </div>
    </section>
    <div class="notification is-success" id="notificationSuccess">
      <button class="delete" id="closeNotification"></button>
      <span id="notificationText"></span>
    </div>
    <footer>
      <p><strong>FileShare</strong> &copy; 2025 | Made with <i class="fas fa-heart has-text-danger"></i> by Maksim</p>
    </footer>
  </div>

  <script>
    console.log("🍿 Script starting...");

    let currentFolderId = null;
    console.log("Initial currentFolderId:", currentFolderId);

    // Authentication & Initialization
    document.addEventListener('DOMContentLoaded', () => {
      console.log("[DOMContentLoaded] event fired");
      const token = localStorage.getItem('jwtToken');
      console.log("Retrieved token from localStorage:", token);
      if (!token) {
        console.log("No token found, redirecting to /index.html");
        return window.location.href = '/index.html';
      }

      console.log("Verifying token with server...");
      fetch('http://localhost:3000/api/verify-token', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => {
        console.log("verify-token response status:", res.status);
        if (!res.ok) {
          console.warn("Token invalid, removing and redirecting");
          localStorage.removeItem('jwtToken');
          window.location.href = '/index.html';
        } else {
          console.log("Token valid, loading My Drive");
          showMyDrive();
        }
      })
      .catch(err => {
        console.error("Error during token verification:", err);
        localStorage.removeItem('jwtToken');
        window.location.href = '/index.html';
      });
    });

    /* ===== Dashboard Functions ===== */
    function showCreateFolderModal() {
      console.log("showCreateFolderModal() called");
      document.getElementById('createFolderModal').style.display = 'flex';
      document.getElementById('folderNameInput').focus();
      console.log("Modal displayed and input focused");
    }
    function hideCreateFolderModal() {
      console.log("hideCreateFolderModal() called");
      document.getElementById('createFolderModal').style.display = 'none';
      document.getElementById('folderNameInput').value = '';
      console.log("Modal hidden and input cleared");
    }
    async function createFolder() {
      console.log("createFolder() called");
      const name = document.getElementById('folderNameInput').value.trim();
      console.log("Folder name entered:", name);
      if (!name) {
        console.warn("Empty folder name, aborting createFolder");
        return;
      }
      const token = localStorage.getItem('jwtToken');
      console.log("Token for createFolder:", token);
      try {
        console.log("Sending POST to /api/create-folder");
        const res = await fetch('http://localhost:3000/api/create-folder', {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ folderName: name })
        });
        console.log("create-folder response:", res.status);
        const data = await res.json();
        console.log("Response JSON:", data);
        if (res.ok) {
          console.log("Folder created successfully, hiding modal and refreshing");
          hideCreateFolderModal();
          showMyDrive();
        } else {
          console.error("Error creating folder:", data.message);
          alert(data.message || 'Error creating folder');
        }
      } catch(err) {
        console.error("Exception in createFolder():", err);
        alert('Error creating folder: ' + err.message);
      }
    }
    async function showMyDrive() {
      console.log("showMyDrive() called");
      document.getElementById('dashboardPage').style.display = 'flex';
      document.getElementById('folderPage').style.display = 'none';
      document.body.classList.remove('folder-view-active');
      console.log("Dashboard view shown, folder view hidden");

      const token = localStorage.getItem('jwtToken');
      console.log("Token for fetching folders:", token);
      try {
        console.log("Fetching /api/folders");
        const res = await fetch('http://localhost:3000/api/folders', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log("Folders fetch status:", res.status);
        const folders = await res.json();
        console.log("Fetched folders array:", folders);
        const grid = document.getElementById('folderGrid');
        grid.innerHTML = folders.map(f => {
          console.log("Rendering folder:", f);
          return `
            <div class="folder-item" onclick="openFolder('${f.folderId}')">
              <div class="folder-icon"><i class="fas fa-folder"></i></div>
              <div class="folder-name">${f.folderName.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
            </div>`;
        }).join('');
        console.log("Folder grid updated");
      } catch(err) {
        console.error("Error in showMyDrive():", err);
      }
    }
    function openFolder(folderId) {
      console.log("openFolder() called with folderId:", folderId);
      currentFolderId = folderId;
      document.getElementById('folderId').textContent = folderId;
      document.getElementById('dashboardPage').style.display = 'none';
      document.getElementById('folderPage').style.display = 'flex';
      document.body.classList.add('folder-view-active');
      console.log("Folder view activated for ID:", currentFolderId);
      fetchFolderContents();
    }
    function backToDashboard() {
      console.log("backToDashboard() called");
      showMyDrive();
    }

    /* ===== Folder View Functions ===== */
    function formatFileSize(bytes) {
      console.log("formatFileSize() called with bytes:", bytes);
      if (bytes === 0) {
        console.log("Bytes is zero");
        return '0 Bytes';
      }
      const k = 1024, sizes = ['Bytes','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      const result = parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i];
      console.log("Formatted file size:", result);
      return result;
    }
    function formatDate(dateStr) {
      console.log("formatDate() called with:", dateStr);
      const result = new Date(dateStr).toLocaleString();
      console.log("Formatted date:", result);
      return result;
    }
    function getFileIcon(ext) {
      console.log("getFileIcon() for extension:", ext);
      const map = {
        '.pdf':'fa-file-pdf','.doc':'fa-file-word','.docx':'fa-file-word',
        '.xls':'fa-file-excel','.xlsx':'fa-file-excel','.ppt':'fa-file-powerpoint',
        '.pptx':'fa-file-powerpoint','.jpg':'fa-file-image','.jpeg':'fa-file-image',
        '.png':'fa-file-image','.gif':'fa-file-image','.txt':'fa-file-alt',
        '.zip':'fa-file-archive','.rar':'fa-file-archive','.mp3':'fa-file-audio',
        '.mp4':'fa-file-video','.html':'fa-file-code','.css':'fa-file-code',
        '.js':'fa-file-code'
      };
      const icon = map[ext] || 'fa-file';
      console.log("Icon chosen:", icon);
      return icon;
    }
    function showNotification(msg, type='is-success') {
      console.log("showNotification() called with:", msg, type);
      const n = document.getElementById('notificationSuccess');
      n.className = `notification ${type} show`;
      document.getElementById('notificationText').textContent = msg;
      console.log("Notification displayed:", msg);
      setTimeout(() => {
        n.classList.remove('show');
        console.log("Notification hidden after timeout");
      }, 5000);
    }
    document.getElementById('closeNotification').addEventListener('click', () => {
      console.log("Close notification button clicked");
      document.getElementById('notificationSuccess').classList.remove('show');
    });

    async function fetchFolderContents() {
      console.log("fetchFolderContents() called for folder:", currentFolderId);
      const token = localStorage.getItem('jwtToken');
      console.log("Token for fetchFolderContents:", token);
      const cont = document.getElementById('folderContents');
      const spinner = document.getElementById('loadingSpinner');
      spinner.style.display = 'block';
      cont.innerHTML = '';
      console.log("Spinner shown, contents cleared");
      try {
        console.log(`Fetching /api/folder-contents?folderID=${currentFolderId}`);
        const res = await fetch(`http://localhost:3000/api/folder-contents?folderID=${currentFolderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log("folder-contents status:", res.status);
        const files = await res.json();
        console.log("Fetched files array:", files);
        spinner.style.display = 'none';
        if (!res.ok) {
          cont.innerHTML = `<div class="notification is-warning">${files.message||'Error'}</div>`;
          console.warn("Error fetching contents:", files.message);
        } else if (files.length === 0) {
          cont.innerHTML = `
            <div class="empty-folder">
              <i class="fas fa-folder-open fa-3x mb-3" style="color:#ddd;"></i>
              <p>This folder is empty</p>
              <p class="is-size-7 has-text-grey">Upload files to get started</p>
            </div>`;
          console.log("No files in folder");
        } else {
          console.log("Rendering files list");
          cont.innerHTML = files.map((f,i)=> {
            console.log("Rendering file", i, f);
            const name = f.filename||`File ${i}`;
            const ext = (f.type||'').toLowerCase();
            return `
              <div class="file-item" data-filename="${name}">
                <div class="file-icon"><i class="fas ${getFileIcon(ext)}"></i></div>
                <div class="file-info">
                  <span class="file-name">${name}</span>
                  <div class="file-meta">
                    <span class="file-size">${formatFileSize(f.size||0)}</span>
                    <span class="file-date">${formatDate(f.modified||new Date())}</span>
                  </div>
                </div>
                <div class="file-actions">
                  <button class="button is-small is-info download-button" data-filename="${name}">
                    <span class="icon"><i class="fas fa-download"></i></span>
                  </button>
                  <button class="button is-small is-danger delete-button" data-filename="${name}">
                    <span class="icon"><i class="fas fa-trash-alt"></i></span>
                  </button>
                </div>
              </div>`;
          }).join('');
          console.log("File items injected into DOM");
          document.querySelectorAll('.download-button').forEach(b=>{
            console.log("Binding download event for", b.dataset.filename);
            b.addEventListener('click', ()=>downloadFile(b.dataset.filename));
          });
          document.querySelectorAll('.delete-button').forEach(b=>{
            console.log("Binding delete event for", b.dataset.filename);
            b.addEventListener('click', ()=>deleteFile(b.dataset.filename));
          });
        }
      } catch(err) {
        spinner.style.display = 'none';
        cont.innerHTML = `<div class="notification is-danger">Error: ${err.message}</div>`;
        console.error("Exception in fetchFolderContents():", err);
      }
    }

    async function downloadFile(name) {
      console.log("downloadFile() called for:", name);
      const token = localStorage.getItem('jwtToken');
      try {
        console.log("Requesting download token for file:", name);
        const tokenRes = await fetch(`http://localhost:3000/api/generate-download-token?folderID=${currentFolderId}&filename=${encodeURIComponent(name)}`, {
          headers:{ 'Authorization':`Bearer ${token}` }
        });
        console.log("generate-download-token status:", tokenRes.status);
        const { token:dlToken } = await tokenRes.json();
        console.log("Download token received:", dlToken);
        const res = await fetch(`http://localhost:3000/api/download-file?token=${dlToken}`);
        console.log("download-file response status:", res.status);
        const blob = await res.blob();
        console.log("Blob received:", blob);
        const url = URL.createObjectURL(blob);
        console.log("Object URL created:", url);
        const a = document.createElement('a');
        a.href = url; a.download = name; document.body.append(a); a.click();
        console.log("Download link clicked programmatically");
        URL.revokeObjectURL(url); a.remove();
        console.log("Object URL revoked, link removed");
        showNotification(`Downloaded ${name}`);
      } catch(err) {
        console.error("downloadFile error:", err);
        showNotification(`Download failed: ${err.message}`, 'is-danger');
      }
    }

    async function deleteFile(name) {
      console.log("deleteFile() called for:", name);
      if (!confirm(`Delete ${name}?`)) {
        console.log("User canceled deletion");
        return;
      }
      console.log("User confirmed deletion");
      const token = localStorage.getItem('jwtToken');
      try {
        console.log("Sending DELETE to server for file:", name);
        const res = await fetch(`http://localhost:3000/api/delete-file/${currentFolderId}/${encodeURIComponent(name)}`, {
          method:'DELETE',
          headers:{ 'Authorization':`Bearer ${token}` }
        });
        console.log("delete-file response status:", res.status);
        const data = await res.json();
        console.log("delete-file response JSON:", data);
        if (res.ok) {
          console.log("File deleted successfully");
          showNotification(data.message||'Deleted');
          fetchFolderContents();
        } else {
          console.error("Error deleting file:", data.message);
          showNotification(data.message||'Error', 'is-danger');
        }
      } catch(err) {
        console.error("Exception in deleteFile():", err);
        showNotification(`Error: ${err.message}`, 'is-danger');
      }
    }

    // Upload & Drag-drop
    console.log("Setting up upload & drag-drop handlers");
    const fileInput = document.getElementById('fileInput'),
          fileNameEl = document.getElementById('fileName'),
          uploadBtn = document.getElementById('uploadButton'),
          dropZone = document.getElementById('dropZone'),
          progressContainer = document.getElementById('progressContainer'),
          uploadProgress = document.getElementById('uploadProgress'),
          progressText = document.getElementById('progressText'),
          refreshBtn = document.getElementById('refreshButton'),
          searchInput = document.getElementById('searchInput');

    fileInput.addEventListener('change', () => {
      console.log("fileInput change event");
      const f = fileInput.files[0];
      console.log("Selected file:", f);
      fileNameEl.textContent = f ? f.name : 'No file selected';
      uploadBtn.disabled = !f;
      console.log("Upload button disabled state:", uploadBtn.disabled);
    });
    uploadBtn.addEventListener('click', () => {
      console.log("Upload button clicked");
      uploadFile();
    });
    refreshBtn.addEventListener('click', () => {
      console.log("Refresh button clicked");
      fetchFolderContents();
    });
    searchInput.addEventListener('input', () => {
      console.log("Search input:", searchInput.value);
      const term = searchInput.value.toLowerCase();
      document.querySelectorAll('.file-item').forEach(item => {
        const match = item.querySelector('.file-name').textContent.toLowerCase().includes(term);
        item.style.display = match ? 'flex' : 'none';
        console.log(`Item ${item.dataset.filename} match=${match}`);
      });
    });

    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
      dropZone.addEventListener(evt, e => {
        console.log(`dropZone ${evt} event`, e);
        e.preventDefault(); e.stopPropagation();
      });
    });
    ['dragenter','dragover'].forEach(evt => {
      dropZone.addEventListener(evt, () => {
        console.log(`dropZone add active on ${evt}`);
        dropZone.classList.add('active');
      });
    });
    ['dragleave','drop'].forEach(evt => {
      dropZone.addEventListener(evt, () => {
        console.log(`dropZone remove active on ${evt}`);
        dropZone.classList.remove('active');
      });
    });
    dropZone.addEventListener('drop', e => {
      console.log("dropZone drop event");
      const files = e.dataTransfer.files;
      console.log("Dropped files:", files);
      if (files.length) {
        fileInput.files = files;
        fileNameEl.textContent = files[0].name;
        uploadBtn.disabled = false;
        console.log("File selected via drag-drop:", files[0].name);
      }
    });

    function uploadFile() {
      console.log("uploadFile() called");
      const token = localStorage.getItem('jwtToken'), file = fileInput.files[0];
      console.log("File to upload:", file);
      if (!file) {
        console.warn("No file selected for upload");
        return showNotification('Select a file', 'is-warning');
      }
      const form = new FormData();
      form.append('file', file);
      console.log("FormData prepared");

      uploadBtn.classList.add('is-loading');
      console.log("Upload button loading state enabled");
      progressContainer.style.display = 'block';
      console.log("Progress container shown");

      const xhr = new XMLHttpRequest();
      xhr.upload.addEventListener('progress', ev => {
        if (ev.lengthComputable) {
          const pct = Math.round(ev.loaded/ev.total*100);
          uploadProgress.value = pct;
          progressText.textContent = pct+'%';
          console.log(`Upload progress: ${pct}%`);
        }
      });
      xhr.onload = () => {
        console.log("XHR upload onload, status:", xhr.status);
        uploadBtn.classList.remove('is-loading');
        console.log("Upload button loading state removed");
        progressContainer.style.display = 'none';
        console.log("Progress container hidden");
        fileInput.value = '';
        fileNameEl.textContent = 'No file selected';
        uploadBtn.disabled = true;
        console.log("Input reset and upload button disabled");
        const res = JSON.parse(xhr.responseText);
        console.log("XHR response JSON:", res);
        if (xhr.status===200) {
          console.log("Upload successful:", res.message);
          showNotification(res.message||'Uploaded');
          fetchFolderContents();
        } else {
          console.error("Upload failed:", res.message);
          showNotification(res.message||'Error uploading','is-danger');
        }
      };
      xhr.onerror = () => {
        console.error("Network error during upload");
        showNotification('Network error','is-danger');
        uploadBtn.classList.remove('is-loading');
        progressContainer.style.display = 'none';
      };
      const url = `http://localhost:3000/api/upload-file/${currentFolderId}`;
      console.log("Opening XHR to", url);
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      console.log("Authorization header set");
      xhr.send(form);
      console.log("Form data sent");
    }

    console.log("🍿 Script fully initialized");
  </script>
</body>
</html>
