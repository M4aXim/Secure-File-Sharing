<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Staff â€“ Scan Folder Contents</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .result-container {
      max-height: 500px;
      overflow-y: auto;
      margin-top: 1.5rem;
      display: none;
    }
    .file-icon {
      margin-right: 10px;
      width: 24px;
      text-align: center;
    }
    .file-size {
      color: #666;
      font-size: 0.9em;
    }
    .file-date {
      color: #666;
      font-size: 0.9em;
    }
    .navbar {
      box-shadow: 0 2px 3px rgba(10, 10, 10, 0.1);
    }
    .main-content {
      padding-top: 1.5rem;
    }
    .file-list {
      margin-top: 1rem;
    }
    .loading-indicator {
      display: none;
      text-align: center;
      padding: 2rem;
    }
    .file-item {
      transition: background-color 0.2s;
    }
    .file-item:hover {
      background-color: #f8f8f8;
    }
    .error-message {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar is-light">
    <div class="container">
      <div class="navbar-brand">
        <span class="navbar-item">
          <span class="icon">
            <i class="fas fa-folder-open"></i>
          </span>
          <strong>Staff Portal</strong>
        </span>
      </div>
      <div class="navbar-menu">
        <div class="navbar-end">
          <div class="navbar-item">
            <button id="logout-button" class="button is-light">
              <span class="icon">
                <i class="fas fa-sign-out-alt"></i>
              </span>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <section class="section main-content">
    <div class="container">
      <h1 class="title is-3">
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-search"></i>
          </span>
          <span>Scan Folder Contents</span>
        </span>
      </h1>
      
      <!-- Search Form -->
      <div class="box">
        <form id="form">
          <div class="field has-addons">
            <div class="control is-expanded">
              <input class="input" type="text" id="folderId" placeholder="Enter Folder ID" required>
            </div>
            <div class="control">
              <button type="submit" class="button is-primary">
                <span class="icon">
                  <i class="fas fa-search"></i>
                </span>
                <span>Scan</span>
              </button>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Loading Indicator -->
      <div id="loading" class="loading-indicator">
        <span class="icon is-large">
          <i class="fas fa-spinner fa-pulse fa-2x"></i>
        </span>
        <p class="mt-2">Scanning folder contents...</p>
      </div>
      
      <!-- Error Message -->
      <div id="error-container" class="notification is-danger error-message">
        <button class="delete" id="close-error"></button>
        <div id="error-message"></div>
      </div>
      
      <!-- Results -->
      <div id="results-container" class="result-container">
        <div class="box">
          <h2 class="subtitle">
            <span class="icon-text">
              <span class="icon">
                <i class="fas fa-folder"></i>
              </span>
              <span>Folder Contents: <span id="current-folder-id"></span></span>
            </span>
            <span class="is-pulled-right">
              <span id="file-count" class="tag is-info">0 files</span>
            </span>
          </h2>
          
          <div class="tabs">
            <ul>
              <li class="is-active"><a id="tab-view">Visual View</a></li>
              <li><a id="tab-json">JSON Data</a></li>
            </ul>
          </div>
          
          <!-- Visual View -->
          <div id="visual-view">
            <div class="file-list" id="file-list">
              <!-- Files will be inserted here -->
            </div>
          </div>
          
          <!-- JSON View -->
          <div id="json-view" style="display: none;">
            <pre id="output" class="has-background-white-ter p-4 is-family-monospace" style="max-height: 400px; overflow: auto;"></pre>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    (async function(){
      // Get token from storage or prompt
      const token = localStorage.getItem('jwtToken') || prompt('Enter JWT token');
      
      // Store token in localStorage for future use
      if (token) {
        localStorage.setItem('jwtToken', token);
      }
      
      // Logout button
      document.getElementById('logout-button').addEventListener('click', () => {
        localStorage.removeItem('jwtToken');
        alert('Logged out successfully');
        location.reload();
      });
      
      // Toggle between visual and JSON views
      document.getElementById('tab-view').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('tab-view').parentElement.classList.add('is-active');
        document.getElementById('tab-json').parentElement.classList.remove('is-active');
        document.getElementById('visual-view').style.display = 'block';
        document.getElementById('json-view').style.display = 'none';
      });
      
      document.getElementById('tab-json').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('tab-json').parentElement.classList.add('is-active');
        document.getElementById('tab-view').parentElement.classList.remove('is-active');
        document.getElementById('visual-view').style.display = 'none';
        document.getElementById('json-view').style.display = 'block';
      });
      
      // Close error message
      document.getElementById('close-error').addEventListener('click', () => {
        document.getElementById('error-container').style.display = 'none';
      });
      
      // Form submission
      document.getElementById('form').onsubmit = async e => {
        e.preventDefault();
        const folderId = document.getElementById('folderId').value.trim();
        
        if (!folderId) {
          showError('Please enter a folder ID');
          return;
        }
        
        // Show loading indicator and hide results
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('error-container').style.display = 'none';
        
        try {
          const res = await fetch(`/api/staff/folder-contents?folderId=${folderId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (!res.ok) {
            throw new Error(await res.text() || `Error: ${res.status} ${res.statusText}`);
          }
          
          const data = await res.json();
          
          // Hide loading indicator
          document.getElementById('loading').style.display = 'none';
          
          // Show results
          document.getElementById('results-container').style.display = 'block';
          document.getElementById('current-folder-id').textContent = folderId;
          
          // Parse and display files
          renderFileList(data);
          
          // Display raw JSON
          document.getElementById('output').textContent = JSON.stringify(data, null, 2);
          
          // Update file count
          const fileCount = data.filter(item => item && item.filename).length;
          document.getElementById('file-count').textContent = `${fileCount} files`;
          
        } catch (err) {
          document.getElementById('loading').style.display = 'none';
          showError('Error: ' + err.message);
        }
      };
      
      // Show error message
      function showError(message) {
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        
        errorMessage.textContent = message;
        errorContainer.style.display = 'block';
      }
      
      // Render file list
      function renderFileList(files) {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';
        
        // Create table
        const table = document.createElement('table');
        table.className = 'table is-fullwidth is-hoverable';
        
        // Create table header
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>File Name</th>
            <th>Size</th>
            <th>Last Modified</th>
            <th>Type</th>
          </tr>
        `;
        table.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');
        
        // Add files to table
        files.forEach(file => {
          if (file && file.filename) {
            const row = document.createElement('tr');
            row.className = 'file-item';
            
            // Get file extension
            const fileExtension = file.type || (file.filename.includes('.') ? 
              file.filename.split('.').pop().toLowerCase() : '');
            
            // Determine icon
            let icon = 'fas fa-file';
            if (fileExtension === '.pdf' || fileExtension === 'pdf') {
              icon = 'fas fa-file-pdf';
            } else if (fileExtension === '.mp3' || fileExtension === 'mp3') {
              icon = 'fas fa-file-audio';
            } else if (fileExtension === '.mp4' || fileExtension === 'mp4') {
              icon = 'fas fa-file-video';
            } else if (fileExtension === '.txt' || fileExtension === 'txt') {
              icon = 'fas fa-file-alt';
            } else if (fileExtension === '.jpg' || fileExtension === '.png' || 
                       fileExtension === 'jpg' || fileExtension === 'png') {
              icon = 'fas fa-file-image';
            }
            
            // Format file size
            const size = formatFileSize(file.size);
            
            // Format date
            const date = file.lastModified ? new Date(file.lastModified).toLocaleString() : 'Unknown';
            
            row.innerHTML = `
              <td>
                <span class="icon-text">
                  <span class="icon file-icon">
                    <i class="${icon}"></i>
                  </span>
                  <span>${file.filename}</span>
                </span>
              </td>
              <td class="file-size">${size}</td>
              <td class="file-date">${date}</td>
              <td>${fileExtension || 'Unknown'}</td>
            `;
            
            tbody.appendChild(row);
          }
        });
        
        table.appendChild(tbody);
        fileList.appendChild(table);
      }
      
      // Format file size
      function formatFileSize(bytes) {
        if (!bytes) return 'Unknown';
        
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        if (bytes === 0) return '0 Byte';
        const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
      }
    })();
  </script>
</body>
</html>