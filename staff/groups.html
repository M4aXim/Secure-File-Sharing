<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff - Group Monitoring</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .group-card {
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .group-card:hover {
            transform: translateY(-2px);
        }
        .stats-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .flagged {
            border-left: 4px solid #ff3860;
        }
    </style>
</head>
<body>
    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/staff/dashboard.html">
                <i class="fas fa-shield-alt mr-2"></i>
                Staff Dashboard
            </a>
        </div>
        <div class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item" href="/staff/users.html">
                    <i class="fas fa-users mr-2"></i>
                    Users
                </a>
                <a class="navbar-item is-active" href="/staff/groups.html">
                    <i class="fas fa-user-friends mr-2"></i>
                    Groups
                </a>
                <a class="navbar-item" href="/staff/audit.html">
                    <i class="fas fa-history mr-2"></i>
                    Audit Log
                </a>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h1 class="title">
                <i class="fas fa-user-friends mr-2"></i>
                Group Monitoring
            </h1>

            <!-- Stats Overview -->
            <div class="columns is-multiline mb-6">
                <div class="column is-3">
                    <div class="stats-card">
                        <h3 class="subtitle is-6">Total Groups</h3>
                        <p class="title is-4" id="totalGroups">-</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="stats-card">
                        <h3 class="subtitle is-6">Total Members</h3>
                        <p class="title is-4" id="totalMembers">-</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="stats-card">
                        <h3 class="subtitle is-6">Flagged Groups</h3>
                        <p class="title is-4" id="flaggedGroups">-</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="stats-card">
                        <h3 class="subtitle is-6">Pending Invites</h3>
                        <p class="title is-4" id="pendingInvites">-</p>
                    </div>
                </div>
            </div>

            <!-- Groups List -->
            <div class="box">
                <h2 class="title is-4 mb-4">All Groups</h2>
                <div id="groupsList">
                    <!-- Groups will be loaded here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Group Details Modal -->
    <div class="modal" id="groupModal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="modalGroupName">Group Details</p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <div class="tabs">
                    <ul>
                        <li class="is-active"><a data-tab="members">Members</a></li>
                        <li><a data-tab="activity">Activity</a></li>
                    </ul>
                </div>

                <div id="membersTab" class="tab-content">
                    <div id="membersList" class="mt-4">
                        <!-- Members will be loaded here -->
                    </div>
                </div>

                <div id="activityTab" class="tab-content" style="display: none;">
                    <div id="activityList" class="mt-4">
                        <!-- Activity will be loaded here -->
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" id="flagGroupBtn">
                    <span class="icon">
                        <i class="fas fa-flag"></i>
                    </span>
                    <span>Flag Group</span>
                </button>
                <button class="button" id="closeModalBtn">Close</button>
            </footer>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading" style="display: none;">
        <div class="box">
            <span class="icon is-large has-text-primary">
                <i class="fas fa-spinner fa-pulse fa-2x"></i>
            </span>
        </div>
    </div>

    <script>
        let currentGroupId = null;
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = '/index.html';
        }

        // Load initial data
        loadStats();
        loadGroups();

        async function loadStats() {
            try {
                const res = await fetch('/api/staff/groups/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await res.json();
                
                document.getElementById('totalGroups').textContent = stats.totalGroups;
                document.getElementById('totalMembers').textContent = stats.totalMembers;
                document.getElementById('flaggedGroups').textContent = stats.flaggedGroups;
                document.getElementById('pendingInvites').textContent = stats.totalPendingInvites;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadGroups() {
            showLoading();
            try {
                const res = await fetch('/api/staff/groups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const groupsList = document.getElementById('groupsList');
                if (data.groups.length === 0) {
                    groupsList.innerHTML = `
                        <div class="notification is-info">
                            <p>No groups found in the system.</p>
                        </div>
                    `;
                    return;
                }

                groupsList.innerHTML = data.groups.map(group => `
                    <div class="card group-card ${group.flagged ? 'flagged' : ''}">
                        <div class="card-content">
                            <div class="level">
                                <div class="level-left">
                                    <div class="level-item">
                                        <div>
                                            <p class="title is-4">${group.groupName}</p>
                                            <p class="subtitle is-6">Owner: ${group.owner}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="level-right">
                                    <div class="level-item">
                                        <div class="tags">
                                            <span class="tag is-info">${group.memberCount} members</span>
                                            <span class="tag is-warning">${group.pendingInviteCount} pending</span>
                                            <span class="tag is-primary">${group.folderCount} folders</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="content">
                                <button class="button is-primary is-fullwidth" 
                                        onclick="openGroupDetails('${group.groupId}', '${group.groupName}')">
                                    <span class="icon">
                                        <i class="fas fa-cog"></i>
                                    </span>
                                    <span>Manage Group</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load groups:', err);
                document.getElementById('groupsList').innerHTML = `
                    <div class="notification is-danger">
                        <p>Failed to load groups. Please try again later.</p>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        async function openGroupDetails(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('modalGroupName').textContent = groupName;
            showLoading();

            try {
                // Load members
                const membersRes = await fetch(`/api/groups/members/${groupId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const membersData = await membersRes.json();
                
                document.getElementById('membersList').innerHTML = membersData.members.map(member => `
                    <div class="box">
                        <div class="level">
                            <div class="level-left">
                                <div class="level-item">
                                    <span class="icon mr-2 has-text-info">
                                        <i class="fas fa-user-circle"></i>
                                    </span>
                                    <span>${member.username}</span>
                                </div>
                            </div>
                            <div class="level-right">
                                <div class="level-item">
                                    <button class="button is-danger is-small" 
                                            onclick="removeMember('${groupId}', '${member.username}')">
                                        <span class="icon">
                                            <i class="fas fa-user-minus"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Load activity
                const activityRes = await fetch(`/api/staff/groups/${groupId}/activity`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const activityData = await activityRes.json();
                
                document.getElementById('activityList').innerHTML = activityData.activities.map(activity => `
                    <div class="box">
                        <div class="level">
                            <div class="level-left">
                                <div class="level-item">
                                    <span class="icon mr-2 has-text-info">
                                        <i class="fas fa-history"></i>
                                    </span>
                                    <span>${activity.activity}</span>
                                </div>
                            </div>
                            <div class="level-right">
                                <div class="level-item">
                                    <span class="tag is-light">
                                        ${new Date(activity.timestamp).toLocaleString()}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Show modal
                document.getElementById('groupModal').classList.add('is-active');
            } catch (err) {
                console.error('Error loading group details:', err);
            } finally {
                hideLoading();
            }
        }

        async function removeMember(groupId, username) {
            if (!confirm(`Are you sure you want to remove ${username} from this group?`)) {
                return;
            }

            showLoading();
            try {
                const res = await fetch(`/api/staff/groups/${groupId}/members/${username}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(await res.text());
                }

                // Refresh the view
                openGroupDetails(groupId, document.getElementById('modalGroupName').textContent);
                loadGroups(); // Refresh the main list
            } catch (err) {
                console.error('Failed to remove member:', err);
                alert('Failed to remove member: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        async function flagGroup() {
            const reason = prompt('Please enter the reason for flagging this group:');
            if (!reason) return;

            showLoading();
            try {
                const res = await fetch(`/api/staff/groups/${currentGroupId}/flag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ reason })
                });

                if (!res.ok) {
                    throw new Error(await res.text());
                }

                alert('Group flagged successfully');
                loadGroups(); // Refresh the list
            } catch (err) {
                console.error('Failed to flag group:', err);
                alert('Failed to flag group: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // Modal handling
        document.querySelector('.modal .delete').onclick = () => {
            document.getElementById('groupModal').classList.remove('is-active');
        };

        document.getElementById('closeModalBtn').onclick = () => {
            document.getElementById('groupModal').classList.remove('is-active');
        };

        // Tab switching
        document.querySelectorAll('.tabs a').forEach(tab => {
            tab.onclick = (e) => {
                e.preventDefault();
                const target = e.target.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tabs li').forEach(li => li.classList.remove('is-active'));
                e.target.parentElement.classList.add('is-active');
                
                // Show target content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(target + 'Tab').style.display = 'block';
            };
        });

        function showLoading() {
            document.querySelector('.loading').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
        }
    </script>
</body>
</html> 