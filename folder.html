<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Folder View - FileShare</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .content-box {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      margin: 3rem auto;
      max-width: 900px;
      transition: all 0.3s ease;
    }

    .content-box:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
    }

    footer {
      margin-top: auto;
      padding: 1.5rem;
      background-color: rgba(255, 255, 255, 0.8);
      text-align: center;
      color: #555;
      font-weight: 500;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      background-color: #f9f9f9;
      transition: all 0.2s ease;
    }

    .file-item:hover {
      background-color: #f0f0f0;
      transform: translateY(-2px);
    }

    .file-icon {
      margin-right: 1rem;
      color: #4a6fa5;
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .file-info {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-name {
      font-weight: 500;
      color: #333;
    }

    .file-meta {
      color: #777;
      font-size: 0.85rem;
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
    }

    .empty-folder {
      text-align: center;
      padding: 3rem 1rem;
      color: #888;
    }

    .drop-zone {
      border: 2px dashed #4a6fa5;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      transition: all 0.3s ease;
      background-color: rgba(74, 111, 165, 0.05);
    }

    .drop-zone.active {
      background-color: rgba(74, 111, 165, 0.15);
      border-color: #3273dc;
    }

    .progress-container {
      display: none;
      margin-top: 1rem;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-100px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .loading-spinner {
      display: none;
      margin: 0 auto;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(74, 111, 165, 0.3);
      border-radius: 50%;
      border-top-color: #3273dc;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .file-size {
      white-space: nowrap;
      margin-left: 1rem;
    }

    .file-date {
      white-space: nowrap;
      margin-left: 1rem;
    }
    
    /* Modal for permissions management */
    .modal-card-title {
      color: #4a6fa5;
    }
    
    .permission-row {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .permission-username {
      flex-grow: 1;
      font-weight: 500;
    }
    
    .permission-switches {
      display: flex;
      gap: 1rem;
    }
    
    .permission-label {
      font-size: 0.8rem;
      color: #777;
    }

    /* Bulma Switch */
    .switch[type="checkbox"] {
      outline: 0;
      user-select: none;
      position: absolute;
      margin-bottom: 0;
      opacity: 0;
      left: 0;
    }

    .switch[type="checkbox"] + label {
      position: relative;
      display: inline-block;
      padding-left: 3.5rem;
      cursor: pointer;
      line-height: 1.5rem;
    }

    .switch[type="checkbox"] + label::before {
      position: absolute;
      display: block;
      top: 0;
      left: 0;
      width: 3rem;
      height: 1.5rem;
      border: 0.1rem solid transparent;
      border-radius: 0.75rem;
      background: #b5b5b5;
      content: "";
    }

    .switch[type="checkbox"] + label::after {
      display: block;
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      width: 1rem;
      height: 1rem;
      transform: translate3d(0, 0, 0);
      border-radius: 50%;
      background: white;
      transition: all 0.25s ease-out;
      content: "";
    }

    .switch[type="checkbox"]:checked + label::before {
      background: #00d1b2;
    }

    .switch[type="checkbox"]:checked + label::after {
      left: 1.75rem;
    }

    .switch[type="checkbox"].is-small + label {
      padding-left: 2.75rem;
      padding-top: 0.1rem;
    }

    .switch[type="checkbox"].is-small + label::before {
      width: 2.25rem;
      height: 1.125rem;
    }

    .switch[type="checkbox"].is-small + label::after {
      width: 0.75rem;
      height: 0.75rem;
    }

    .switch[type="checkbox"].is-small:checked + label::after {
      left: 1.25rem;
    }

    .switch[type="checkbox"].is-rounded + label::before {
      border-radius: 1.5rem;
    }

    .switch[type="checkbox"].is-info:checked + label::before {
      background: #3298dc;
    }

    .switch[type="checkbox"].is-success:checked + label::before {
      background: #48c774;
    }

    .switch[type="checkbox"].is-danger:checked + label::before {
      background: #f14668;
    }

    .switch[type="checkbox"].is-warning:checked + label::before {
      background: #ffdd57;
    }
  </style>
</head>

<body>
  <section class="section">
    <div class="container">
      <div class="content-box">
        <h1 class="title is-3 has-text-primary">
          <i class="fas fa-folder-open mr-2"></i> Folder Contents
        </h1>
        <p class="subtitle is-6 has-text-grey">Folder ID: <span id="folderId" class="has-text-weight-bold"></span></p>

        <div class="drop-zone" id="dropZone">
          <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: #4a6fa5;"></i>
          <p class="is-size-5 mb-2">Drag & drop files here</p>
          <p class="is-size-7 has-text-grey">or</p>
          <div class="file has-name is-centered my-3">
            <label class="file-label">
              <input class="file-input" type="file" id="fileInput" name="file">
              <span class="file-cta">
                <span class="file-icon">
                  <i class="fas fa-upload"></i>
                </span>
                <span class="file-label">Choose a fileâ€¦</span>
              </span>
              <span class="file-name" id="fileName">No file selected</span>
            </label>
          </div>
          <button class="button is-primary is-small" id="uploadButton" disabled>
            <span class="icon">
              <i class="fas fa-upload"></i>
            </span>
            <span>Upload</span>
          </button>

          <div class="progress-container" id="progressContainer">
            <progress class="progress is-primary" id="uploadProgress" value="0" max="100"></progress>
            <p class="has-text-centered is-size-7 has-text-grey" id="progressText">0%</p>
          </div>
        </div>

        <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
          <div class="buttons">
            <button class="button is-link is-small" id="addFriendButton">
              <span class="icon">
                <i class="fas fa-user-plus"></i>
              </span>
              <span>Add Friend</span>
            </button>
            <button class="button is-info is-small" id="permissionsButton">
              <span class="icon">
                <i class="fas fa-user-shield"></i>
              </span>
              <span>Permissions</span>
            </button>
          </div>
          <div class="field has-addons">
            <div class="control">
              <input class="input is-small" type="text" id="searchInput" placeholder="Search files...">
            </div>
            <div class="control">
              <button class="button is-primary is-small" id="refreshButton">
                <span class="icon">
                  <i class="fas fa-sync-alt"></i>
                </span>
              </button>
            </div>
          </div>
        </div>

        <div id="loadingSpinner" class="loading-spinner my-5"></div>
        <div id="folderContents" class="mb-4"></div>
      </div>
    </div>
  </section>

  <!-- Permissions Modal -->
  <div class="modal" id="permissionsModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Manage Friend Permissions</p>
        <button class="delete" aria-label="close" id="closePermissionsModal"></button>
      </header>
      <section class="modal-card-body">
        <div id="permissionsLoadingSpinner" class="loading-spinner my-3"></div>
        <div id="permissionsContent">
          <div class="notification is-info is-light">
            <i class="fas fa-info-circle mr-2"></i> Loading friends...
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" id="refreshPermissionsButton">Refresh</button>
        <button class="button" id="closePermissionsButton">Close</button>
      </footer>
    </div>
  </div>

  <div class="notification is-success" id="notificationSuccess">
    <button class="delete" id="closeNotification"></button>
    <span id="notificationText"></span>
  </div>

  <footer>
    <p><strong>FileShare</strong> &copy; 2025 | Made with <i class="fas fa-heart has-text-danger"></i> by Maksim</p>
  </footer>

  <script>
    // Auth check on load
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        return window.location.href = '/index.html';
      }
      fetch('http://localhost:3000/api/verify-token', {
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(res => {
        if (!res.ok) {
          localStorage.removeItem('jwtToken');
          window.location.href = '/index.html';
        }
      }).catch(() => {
        localStorage.removeItem('jwtToken');
        window.location.href = '/index.html';
      });
    });

    // DOM refs
    const fileInput        = document.getElementById('fileInput');
    const fileNameDisplay  = document.getElementById('fileName');
    const uploadButton     = document.getElementById('uploadButton');
    const dropZone         = document.getElementById('dropZone');
    const folderContentsDiv= document.getElementById('folderContents');
    const folderIdSpan     = document.getElementById('folderId');
    const progressContainer= document.getElementById('progressContainer');
    const uploadProgress   = document.getElementById('uploadProgress');
    const progressText     = document.getElementById('progressText');
    const loadingSpinner   = document.getElementById('loadingSpinner');
    const refreshButton    = document.getElementById('refreshButton');
    const searchInput      = document.getElementById('searchInput');
    const notification     = document.getElementById('notificationSuccess');
    const notificationText = document.getElementById('notificationText');
    const closeNotification= document.getElementById('closeNotification');
    const permissionsButton= document.getElementById('permissionsButton');
    const permissionsModal = document.getElementById('permissionsModal');
    const permissionsContent = document.getElementById('permissionsContent');
    const closePermissionsModal = document.getElementById('closePermissionsModal');
    const closePermissionsButton = document.getElementById('closePermissionsButton');
    const refreshPermissionsButton = document.getElementById('refreshPermissionsButton');
    const permissionsLoadingSpinner = document.getElementById('permissionsLoadingSpinner');

    // Get folderID
    const urlParams = new URLSearchParams(window.location.search);
    const folderId  = urlParams.get('folderID');
    if (!folderId) {
      window.location.href = '/dashboard.html';
      throw new Error('No folder ID provided');
    }
    folderIdSpan.textContent = folderId;

    // Helpers
    function formatFileSize(bytes) {
      if (!bytes) return '0 Bytes';
      const k = 1024, sizes = ['Bytes','KB','MB','GB','TB'], i = Math.floor(Math.log(bytes)/Math.log(k));
      return `${(bytes/Math.pow(k,i)).toFixed(2)} ${sizes[i]}`;
    }
    function formatDate(d) {
      return new Date(d).toLocaleString();
    }
    function getFileIcon(ext) {
      const icons = {
        '.pdf':'fa-file-pdf','.doc':'fa-file-word','.docx':'fa-file-word',
        '.xls':'fa-file-excel','.xlsx':'fa-file-excel','.ppt':'fa-file-powerpoint',
        '.pptx':'fa-file-powerpoint','.jpg':'fa-file-image','.jpeg':'fa-file-image',
        '.png':'fa-file-image','.gif':'fa-file-image','.txt':'fa-file-alt',
        '.zip':'fa-file-archive','.rar':'fa-file-archive','.mp3':'fa-file-audio',
        '.mp4':'fa-file-video','.html':'fa-file-code','.css':'fa-file-code',
        '.js':'fa-file-code'
      };
      return icons[ext.toLowerCase()] || 'fa-file';
    }
    function showNotification(msg, type = 'is-success') {
      notification.className = `notification ${type}`;
      notificationText.textContent = msg;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 5000);
    }
    closeNotification.addEventListener('click', () => {
      notification.classList.remove('show');
    });

    // Fetch & render
    async function fetchFolderContents() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';

      loadingSpinner.style.display = 'block';
      folderContentsDiv.innerHTML = '';

      try {
        const res = await fetch(`http://localhost:3000/api/folder-contents?folderID=${folderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const contents = await res.json();
        loadingSpinner.style.display = 'none';

        if (!res.ok) {
          return folderContentsDiv.innerHTML = `<div class="notification is-warning">${contents.message||'Error loading'}</div>`;
        }
        if (contents.length === 0) {
          return folderContentsDiv.innerHTML = 
            `<div class="empty-folder">
              <i class="fas fa-folder-open fa-3x mb-3" style="color:#ddd"></i>
              <p>This folder is empty</p>
              <p class="is-size-7 has-text-grey">Upload files to get started</p>
            </div>`;
        }

        const fileItems = contents.map((f,i) => {
          const name = f.filename||`File${i}`, ext = f.type||'', size = formatFileSize(f.size), mod = formatDate(f.modified);
          return `
            <div class="file-item">
              <div class="file-icon">
                <i class="fas ${getFileIcon(ext)}"></i>
              </div>
              <div class="file-info">
                <span class="file-name">${name}</span>
                <div class="file-meta">
                  <span class="file-size">${size}</span>
                  <span class="file-date">${mod}</span>
                </div>
              </div>
              <div class="file-actions">
                <button class="button is-small is-info download-button" data-filename="${name}">
                  <span class="icon"><i class="fas fa-download"></i></span>
                </button>
                <button class="button is-small is-primary view-button" data-filename="${name}">
                  <span class="icon"><i class="fas fa-eye"></i></span>
                </button>
                <button class="button is-small is-danger delete-button" data-filename="${name}">
                  <span class="icon"><i class="fas fa-trash-alt"></i></span>
                </button>
              </div>
            </div>`;
        }).join('');

        folderContentsDiv.innerHTML = fileItems;

        // now bind events
        document.querySelectorAll('.download-button').forEach(btn =>
          btn.addEventListener('click', () => downloadFile(btn.dataset.filename))
        );
        document.querySelectorAll('.view-button').forEach(btn =>
          btn.addEventListener('click', () => viewFile(btn.dataset.filename))
        );
        document.querySelectorAll('.delete-button').forEach(btn =>
          btn.addEventListener('click', () => deleteFile(btn.dataset.filename))
        );

      } catch (err) {
        loadingSpinner.style.display = 'none';
        console.error(err);
        folderContentsDiv.innerHTML = `<div class="notification is-danger">Error: ${err.message}</div>`;
      }
    }

    async function fetchFriendsPermissions() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      
      permissionsLoadingSpinner.style.display = 'block';
      permissionsContent.innerHTML = '';
      
      try {
        // First, get all friends
        const friendsRes = await fetch(`http://localhost:3000/api/show-friends/${folderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!friendsRes.ok) {
          const error = await friendsRes.json();
          throw new Error(error.message || 'Failed to fetch friends');
        }
        
        const friendsData = await friendsRes.json();
        const friends = friendsData.friends || [];
        
        if (!friends || friends.length === 0) {
          permissionsLoadingSpinner.style.display = 'none';
          permissionsContent.innerHTML = `
            <div class="notification is-info is-light">
              <i class="fas fa-info-circle mr-2"></i> No friends have been added to this folder yet.
            </div>
            <p class="has-text-centered my-4">
              <i class="fas fa-user-plus fa-2x" style="color:#ddd"></i>
              <br>
              <span class="is-size-7 has-text-grey mt-2">Use the "Add Friend" button to invite people</span>
            </p>
          `;
          return;
        }

        // Then get their permissions
        const permissionsRes = await fetch(`http://localhost:3000/api/folders/${folderId}/friends/permissions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!permissionsRes.ok) {
          const error = await permissionsRes.json();
          if (permissionsRes.status === 403) {
            permissionsLoadingSpinner.style.display = 'none';
            permissionsContent.innerHTML = `
              <div class="notification is-warning">
                <i class="fas fa-lock mr-2"></i> Only the folder owner can manage permissions.
              </div>
              <div class="box">
                <h4 class="title is-5">Friends in this folder:</h4>
                ${friends.length > 0 ? 
                  `<ul>
                    ${friends.map(friend => `<li><i class="fas fa-user mr-2"></i> ${friend}</li>`).join('')}
                  </ul>` : 
                  '<p class="has-text-grey">No friends added to this folder yet.</p>'
                }
              </div>
            `;
            return;
          }
          throw new Error(error.message || 'Failed to fetch permissions');
        }
        
        const permissionsData = await permissionsRes.json();
        const friendsWithPermissions = permissionsData.friends || [];
        
        permissionsLoadingSpinner.style.display = 'none';
        
        // Show friends list if no permissions data
        if (friendsWithPermissions.length === 0) {
          permissionsContent.innerHTML = `
            <div class="box">
              <h4 class="title is-5">Current Friends:</h4>
              ${friends.map(friend => `
                <div class="permission-row">
                  <div class="permission-username">
                    <i class="fas fa-user mr-2"></i> ${friend}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          return;
        }
        
        // Render permissions UI
        let permissionsHtml = `
          <div class="box">
            <div class="columns is-mobile has-text-weight-bold is-size-7 mb-2">
              <div class="column">USER</div>
              <div class="column has-text-centered">DOWNLOAD</div>
              <div class="column has-text-centered">UPLOAD</div>
              <div class="column has-text-centered">DELETE</div>
              <div class="column has-text-centered">ADD USERS</div>
            </div>
            <hr class="my-2">
        `;
        
        friendsWithPermissions.forEach(friend => {
          const permissions = friend.permissions || {};
          
          permissionsHtml += `
            <div class="permission-row" data-username="${friend.username}">
              <div class="permission-username">
                <i class="fas fa-user mr-2"></i> ${friend.username}
              </div>
              <div class="permission-switches">
                <div class="field has-text-centered">
                  <input id="download-${friend.username}" type="checkbox" class="switch is-rounded is-small is-info" 
                    ${permissions.download ? 'checked' : ''} 
                    onchange="updatePermission('${friend.username}', 'download', this.checked)">
                  <label for="download-${friend.username}" class="permission-label">Download</label>
                </div>
                <div class="field has-text-centered">
                  <input id="upload-${friend.username}" type="checkbox" class="switch is-rounded is-small is-success" 
                    ${permissions.upload ? 'checked' : ''} 
                    onchange="updatePermission('${friend.username}', 'upload', this.checked)">
                  <label for="upload-${friend.username}" class="permission-label">Upload</label>
                </div>
                <div class="field has-text-centered">
                  <input id="delete-${friend.username}" type="checkbox" class="switch is-rounded is-small is-danger" 
                    ${permissions.delete ? 'checked' : ''} 
                    onchange="updatePermission('${friend.username}', 'delete', this.checked)">
                  <label for="delete-${friend.username}" class="permission-label">Delete</label>
                </div>
                <div class="field has-text-centered">
                  <input id="addUsers-${friend.username}" type="checkbox" class="switch is-rounded is-small is-warning" 
                    ${permissions.addUsers ? 'checked' : ''} 
                    onchange="updatePermission('${friend.username}', 'addUsers', this.checked)">
                  <label for="addUsers-${friend.username}" class="permission-label">Add Users</label>
                </div>
              </div>
            </div>
          `;
        });
        
        permissionsHtml += `</div>`;
        permissionsContent.innerHTML = permissionsHtml;
        
      } catch (err) {
        console.error('Error in fetchFriendsPermissions:', err);
        permissionsLoadingSpinner.style.display = 'none';
        permissionsContent.innerHTML = `
          <div class="notification is-danger">
            <i class="fas fa-exclamation-triangle mr-2"></i> Error: ${err.message}
          </div>
        `;
      }
    }

    // Update a friend's permission
    async function updatePermission(username, permType, value) {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      
      try {
        const updateData = {};
        updateData[permType] = value;
        
        const res = await fetch(`http://localhost:3000/api/folders/${folderId}/friends/${username}/permissions`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updateData)
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to update permission');
        }
        
        showNotification(`Permission updated for ${username}`);
      } catch (err) {
        console.error(err);
        showNotification(`Failed to update permission: ${err.message}`, 'is-danger');
        // Reset the checkbox to its previous state
        fetchFriendsPermissions();
      }
    }
    
    // Expose the function to the global scope for use in inline event handlers
    window.updatePermission = updatePermission;

    // Download
    async function downloadFile(filename) {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';

      try {
        const tRes = await fetch(`http://localhost:3000/api/generate-download-token?folderID=${folderId}&filename=${encodeURIComponent(filename)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!tRes.ok) throw new Error('No download token');
        const { token: dl } = await tRes.json();

        const dlRes = await fetch(`http://localhost:3000/api/download-file?token=${dl}`);
        if (!dlRes.ok) throw new Error(dlRes.statusText);
        const blob = await dlRes.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showNotification(`Downloaded ${filename}`);
      } catch (err) {
        console.error(err);
        showNotification(`Download failed: ${err.message}`, 'is-danger');
      }
    }

    // View (redirect to media_view-redarector.html with filename in query)
    function viewFile(filename) {
      window.location.href = 
        `media_view-redarector.html?folderID=${encodeURIComponent(folderId)}&filename=${encodeURIComponent(filename)}`;
    }

    // Delete
    async function deleteFile(filename) {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      if (!confirm(`Delete ${filename}?`)) return;

      try {
        const res = await fetch(`/api/delete-file/${folderId}/${encodeURIComponent(filename)}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || res.statusText);

        showNotification(data.message || 'Deleted');
        fetchFolderContents();
      } catch (err) {
        console.error(err);
        showNotification(`Delete failed: ${err.message}`, 'is-danger');
      }
    }

    // Upload
    async function uploadFile() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      const file = fileInput.files[0];
      if (!file) return showNotification('Select a file first', 'is-warning');

      const form = new FormData();
      form.append('file', file);
      uploadButton.classList.add('is-loading');
      progressContainer.style.display = 'block';

      const xhr = new XMLHttpRequest();
      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded / e.total * 100);
          uploadProgress.value = pct;
          progressText.textContent = pct + '%';
        }
      });
      xhr.onload = () => {
        uploadButton.classList.remove('is-loading');
        progressContainer.style.display = 'none';
        if (xhr.status === 200) {
          showNotification('Uploaded successfully');
          fetchFolderContents();
        } else {
          const err = JSON.parse(xhr.responseText);
          showNotification(err.message || 'Upload error', 'is-danger');
        }
        fileInput.value = '';
        fileNameDisplay.textContent = 'No file selected';
        uploadButton.disabled = true;
        uploadProgress.value = 0;
        progressText.textContent = '0%';
      };
      xhr.onerror = () => {
        uploadButton.classList.remove('is-loading');
        progressContainer.style.display = 'none';
        showNotification('Network error', 'is-danger');
      };
      xhr.open('POST', `http://localhost:3000/api/upload-file/${folderId}`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      xhr.send(form);
    }

    // Modal control
    permissionsButton.addEventListener('click', () => {
      permissionsModal.classList.add('is-active');
      fetchFriendsPermissions();
    });
    
    closePermissionsModal.addEventListener('click', () => {
      permissionsModal.classList.remove('is-active');
    });
    
    closePermissionsButton.addEventListener('click', () => {
      permissionsModal.classList.remove('is-active');
    });
    
    refreshPermissionsButton.addEventListener('click', fetchFriendsPermissions);
    
    // Close modal when clicking outside
    permissionsModal.addEventListener('click', e => {
      if (e.target === permissionsModal) {
        permissionsModal.classList.remove('is-active');
      }
    });

    // UI handlers
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      fileNameDisplay.textContent = f ? f.name : 'No file selected';
      uploadButton.disabled = !f;
    });
    uploadButton.addEventListener('click', uploadFile);
    refreshButton.addEventListener('click', fetchFolderContents);

    // Drag and Drop Handling
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('active');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('active');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length) {
        fileInput.files = files;
        uploadFile();
      }
    });

    // Search functionality
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      const files = document.querySelectorAll('.file-item');
      files.forEach(file => {
        const fileName = file.querySelector('.file-name').textContent.toLowerCase();
        file.style.display = fileName.includes(query) ? '' : 'none';
      });
    });

    // Initial fetch of folder contents
    fetchFolderContents();
  </script>
</body>

</html>
