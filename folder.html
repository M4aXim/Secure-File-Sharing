
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Folder View - FileShare</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .content-box {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      margin: 3rem auto;
      max-width: 900px;
      transition: all 0.3s ease;
    }

    .content-box:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
    }

    footer {
      margin-top: auto;
      padding: 1.5rem;
      background-color: rgba(255, 255, 255, 0.8);
      text-align: center;
      color: #555;
      font-weight: 500;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      background-color: #f9f9f9;
      transition: all 0.2s ease;
    }

    .file-item:hover {
      background-color: #f0f0f0;
      transform: translateY(-2px);
    }

    .file-icon {
      margin-right: 1rem;
      color: #4a6fa5;
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .file-info {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-name {
      font-weight: 500;
      color: #333;
    }

    .file-meta {
      color: #777;
      font-size: 0.85rem;
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
    }

    .empty-folder {
      text-align: center;
      padding: 3rem 1rem;
      color: #888;
    }

    .drop-zone {
      border: 2px dashed #4a6fa5;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      transition: all 0.3s ease;
      background-color: rgba(74, 111, 165, 0.05);
    }

    .drop-zone.active {
      background-color: rgba(74, 111, 165, 0.15);
      border-color: #3273dc;
    }

    .progress-container {
      display: none;
      margin-top: 1rem;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-100px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .loading-spinner {
      display: none;
      margin: 0 auto;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(74, 111, 165, 0.3);
      border-radius: 50%;
      border-top-color: #3273dc;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .file-size {
      white-space: nowrap;
      margin-left: 1rem;
    }

    .file-date {
      white-space: nowrap;
      margin-left: 1rem;
    }
  </style>
</head>

<body>
  <section class="section">
    <div class="container">
      <div class="content-box">
        <h1 class="title is-3 has-text-primary">
          <i class="fas fa-folder-open mr-2"></i> Folder Contents
        </h1>
        <p class="subtitle is-6 has-text-grey">Folder ID: <span id="folderId" class="has-text-weight-bold"></span></p>

        <div class="drop-zone" id="dropZone">
          <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: #4a6fa5;"></i>
          <p class="is-size-5 mb-2">Drag & drop files here</p>
          <p class="is-size-7 has-text-grey">or</p>
          <div class="file has-name is-centered my-3">
            <label class="file-label">
              <input class="file-input" type="file" id="fileInput" name="file">
              <span class="file-cta">
                <span class="file-icon">
                  <i class="fas fa-upload"></i>
                </span>
                <span class="file-label">Choose a file…</span>
              </span>
              <span class="file-name" id="fileName">No file selected</span>
            </label>
          </div>
          <button class="button is-primary is-small" id="uploadButton" disabled>
            <span class="icon">
              <i class="fas fa-upload"></i>
            </span>
            <span>Upload</span>
          </button>

          <div class="progress-container" id="progressContainer">
            <progress class="progress is-primary" id="uploadProgress" value="0" max="100"></progress>
            <p class="has-text-centered is-size-7 has-text-grey" id="progressText">0%</p>
          </div>
        </div>

        <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
          <div class="buttons">
            <button class="button is-link is-small" id="addFriendButton">
              <span class="icon">
                <i class="fas fa-user-plus"></i>
              </span>
              <span>Add Friend</span>
            </button>
            <button class="button is-warning is-small" id="changePermissionButton">
              <span class="icon"><i class="fas fa-user-cog"></i></span>
              <span>Change Permission</span>
            </button>
          </div>
          <div class="field has-addons">
            <div class="control">
              <input class="input is-small" type="text" id="searchInput" placeholder="Search files...">
            </div>
            <div class="control">
              <button class="button is-primary is-small" id="refreshButton">
                <span class="icon">
                  <i class="fas fa-sync-alt"></i>
                </span>
              </button>
            </div>
          </div>
        </div>

        <div id="loadingSpinner" class="loading-spinner my-5"></div>
        <div id="folderContents" class="mb-4"></div>
      </div>
    </div>
  </section>

  <!-- Permission Modal -->
  <div class="modal" id="permissionModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Change Permissions</p>
        <button class="delete" aria-label="close" id="closePermissionModal"></button>
      </header>
      <section class="modal-card-body" id="permissionModalBody">
        <!-- Dynamic content inserted here -->
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" id="savePermissionsButton">Save changes</button>
        <button class="button" id="closePermissionModalFooter">Cancel</button>
      </footer>
    </div>
  </div>

  <div class="notification is-success" id="notificationSuccess">
    <button class="delete" id="closeNotification"></button>
    <span id="notificationText"></span>
  </div>

  <footer>
    <p><strong>FileShare</strong> &copy; 2025 | Made with <i class="fas fa-heart has-text-danger"></i> by Maksim</p>
  </footer>

  <script>
    // Auth check on load
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        return window.location.href = '/index.html';
      }
      fetch('http://localhost:3000/api/verify-token', {
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(res => {
        if (!res.ok) {
          localStorage.removeItem('jwtToken');
          window.location.href = '/index.html';
        }
      }).catch(() => {
        localStorage.removeItem('jwtToken');
        window.location.href = '/index.html';
      });
    });

    // DOM refs
    const fileInput        = document.getElementById('fileInput');
    const fileNameDisplay  = document.getElementById('fileName');
    const uploadButton     = document.getElementById('uploadButton');
    const dropZone         = document.getElementById('dropZone');
    const folderContentsDiv= document.getElementById('folderContents');
    const folderIdSpan     = document.getElementById('folderId');
    const progressContainer= document.getElementById('progressContainer');
    const uploadProgress   = document.getElementById('uploadProgress');
    const progressText     = document.getElementById('progressText');
    const loadingSpinner   = document.getElementById('loadingSpinner');
    const refreshButton    = document.getElementById('refreshButton');
    const searchInput      = document.getElementById('searchInput');
    const notification     = document.getElementById('notificationSuccess');
    const notificationText = document.getElementById('notificationText');
    const closeNotification= document.getElementById('closeNotification');

    // Get folderID
    const urlParams = new URLSearchParams(window.location.search);
    const folderId  = urlParams.get('folderID');
    if (!folderId) {
      window.location.href = '/dashboard.html';
      throw new Error('No folder ID provided');
    }
    folderIdSpan.textContent = folderId;

    // Helpers
    function formatFileSize(bytes) {
      if (!bytes) return '0 Bytes';
      const k = 1024, sizes = ['Bytes','KB','MB','GB','TB'], i = Math.floor(Math.log(bytes)/Math.log(k));
      return `${(bytes/Math.pow(k,i)).toFixed(2)} ${sizes[i]}`;
    }
    function formatDate(d) {
      return new Date(d).toLocaleString();
    }
    function getFileIcon(ext) {
      const icons = {
        '.pdf':'fa-file-pdf','.doc':'fa-file-word','.docx':'fa-file-word',
        '.xls':'fa-file-excel','.xlsx':'fa-file-excel','.ppt':'fa-file-powerpoint',
        '.pptx':'fa-file-powerpoint','.jpg':'fa-file-image','.jpeg':'fa-file-image',
        '.png':'fa-file-image','.gif':'fa-file-image','.txt':'fa-file-alt',
        '.zip':'fa-file-archive','.rar':'fa-file-archive','.mp3':'fa-file-audio',
        '.mp4':'fa-file-video','.html':'fa-file-code','.css':'fa-file-code',
        '.js':'fa-file-code'
      };
      return icons[ext.toLowerCase()] || 'fa-file';
    }
    function showNotification(msg, type = 'is-success') {
      notification.className = `notification ${type}`;
      notificationText.textContent = msg;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 5000);
    }
    closeNotification.addEventListener('click', () => {
      notification.classList.remove('show');
    });

    // Fetch & render
    async function fetchFolderContents() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';

      loadingSpinner.style.display = 'block';
      folderContentsDiv.innerHTML = '';

      try {
        const res = await fetch(`http://localhost:3000/api/folder-contents?folderID=${folderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const contents = await res.json();
        loadingSpinner.style.display = 'none';

        if (!res.ok) {
          return folderContentsDiv.innerHTML = `<div class="notification is-warning">${contents.message||'Error loading'}</div>`;
        }
        if (contents.length === 0) {
          return folderContentsDiv.innerHTML = `
            <div class="empty-folder">
              <i class="fas fa-folder-open fa-3x mb-3" style="color:#ddd"></i>
              <p>This folder is empty</p>
              <p class="is-size-7 has-text-grey">Upload files to get started</p>
            </div>`;
        }

        const fileItems = contents.map((f,i) => {
            const name = f.filename||`File${i}`, ext = f.type||'', size = formatFileSize(f.size), mod = formatDate(f.lastModified);
          return `
            <div class="file-item">
              <div class="file-icon">
                <i class="fas ${getFileIcon(ext)}"></i>
              </div>
              <div class="file-info">
                <span class="file-name">${name}</span>
                <div class="file-meta">
                  <span class="file-size">${size}</span>
                  <span class="file-date">${mod}</span>
                </div>
              </div>
              <div class="file-actions">
                <button class="button is-small is-info download-button" data-filename="${name}">
                  <span class="icon"><i class="fas fa-download"></i></span>
                </button>
                <button class="button is-small is-primary view-button" data-filename="${name}">
                  <span class="icon"><i class="fas fa-eye"></i></span>
                </button>
                <button class="button is-small is-danger delete-button" data-filename="${name}">
                  <span class="icon"><i class="fas fa-trash-alt"></i></span>
                </button>
              </div>
            </div>`;
        }).join('');

        folderContentsDiv.innerHTML = fileItems;

        // now bind events
        document.querySelectorAll('.download-button').forEach(btn =>
          btn.addEventListener('click', () => downloadFile(btn.dataset.filename))
        );
        document.querySelectorAll('.view-button').forEach(btn =>
          btn.addEventListener('click', () => viewFile(btn.dataset.filename))
        );
        document.querySelectorAll('.delete-button').forEach(btn =>
          btn.addEventListener('click', () => deleteFile(btn.dataset.filename))
        );

      } catch (err) {
        loadingSpinner.style.display = 'none';
        console.error(err);
        folderContentsDiv.innerHTML = `<div class="notification is-danger">Error: ${err.message}</div>`;
      }
    }

    // Download
    async function downloadFile(filename) {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';

      try {
        const tRes = await fetch(`http://localhost:3000/api/generate-download-token?folderID=${folderId}&filename=${encodeURIComponent(filename)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!tRes.ok) throw new Error('No download token');
        const { token: dl } = await tRes.json();

        const dlRes = await fetch(`http://localhost:3000/api/download-file?token=${dl}`);
        if (!dlRes.ok) throw new Error(dlRes.statusText);
        const blob = await dlRes.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showNotification(`Downloaded ${filename}`);
      } catch (err) {
        console.error(err);
        showNotification(`Download failed: ${err.message}`, 'is-danger');
      }
    }

    // View (redirect to media_view-redarector.html with filename in query)
    function viewFile(filename) {
      window.location.href =
        `media_view-redarector.html?folderID=${encodeURIComponent(folderId)}&filename=${encodeURIComponent(filename)}`;
    }

    // Delete
    async function deleteFile(filename) {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      if (!confirm(`Delete ${filename}?`)) return;

      try {
        const res = await fetch(`/api/delete-file/${folderId}/${encodeURIComponent(filename)}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || res.statusText);

        showNotification(data.message || 'Deleted');
        fetchFolderContents();
      } catch (err) {
        console.error(err);
        showNotification(`Delete failed: ${err.message}`, 'is-danger');
      }
    }

    // Upload
    async function uploadFile() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      const file = fileInput.files[0];
      if (!file) return showNotification('Select a file first', 'is-warning');

      const form = new FormData();
      form.append('file', file);
      uploadButton.classList.add('is-loading');
      progressContainer.style.display = 'block';

      const xhr = new XMLHttpRequest();
      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded / e.total * 100);
          uploadProgress.value = pct;
          progressText.textContent = pct + '%';
        }
      });
      xhr.onload = () => {
        uploadButton.classList.remove('is-loading');
        progressContainer.style.display = 'none';
        if (xhr.status === 200) {
          showNotification('Uploaded successfully');
          fetchFolderContents();
        } else {
          const err = JSON.parse(xhr.responseText);
          showNotification(err.message || 'Upload error', 'is-danger');
        }
        fileInput.value = '';
        fileNameDisplay.textContent = 'No file selected';
        uploadButton.disabled = true;
        uploadProgress.value = 0;
        progressText.textContent = '0%';
      };
      xhr.onerror = () => {
        uploadButton.classList.remove('is-loading');
        progressContainer.style.display = 'none';
        showNotification('Network error', 'is-danger');
      };
      xhr.open('POST', `http://localhost:3000/api/upload-file/${folderId}`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      xhr.send(form);
    }

    // UI handlers
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      fileNameDisplay.textContent = f ? f.name : 'No file selected';
      uploadButton.disabled = !f;
    });
    uploadButton.addEventListener('click', uploadFile);
    refreshButton.addEventListener('click', fetchFolderContents);

    ['dragenter','dragover','dragnieave','drop'].forEach(ev =>
      dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }, false)
    );
    ['dragenter','dragover'].forEach(ev =>
      dropZone.addEventListener(ev, () => dropZone.classList.add('active'), false)
    );
    ['dragleave','drop'].forEach(ev =>
      dropZone.addEventListener(ev, () => dropZone.classList.remove('active'), false)
    );
    dropZone.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files.length) {
        fileInput.files = files;
        fileNameDisplay.textContent = files[0].name;
        uploadButton.disabled = false;
      }
    });

    document.getElementById('addFriendButton').addEventListener('click', async () => {
      const friendEmail = prompt('Enter the email of the user you want to invite:');
      if (!friendEmail) return;
      const token = localStorage.getItem('jwtToken');
      try {
        const res = await fetch('http://localhost:3000/api/add-friend', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ friendEmail, folderId })
        });
        const data = await res.json();
        if (res.ok) showNotification(data.message || 'Invitation sent!');
        else showNotification(data.message || 'Failed', 'is-danger');
      } catch (err) {
        console.error(err);
        showNotification('Error sending invitation.', 'is-danger');
      }
    });

    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      document.querySelectorAll('.file-item').forEach(item => {
        const name = item.querySelector('.file-name').textContent.toLowerCase();
        item.style.display = name.includes(term) ? 'flex' : 'none';
      });
    });

    // Permission modal code
    const permissionModal = document.getElementById('permissionModal');
    const permissionModalBody = document.getElementById('permissionModalBody');
    const savePermissionsButton = document.getElementById('savePermissionsButton');
    const closePermissionModalButtons = [
      document.getElementById('closePermissionModal'),
      document.getElementById('closePermissionModalFooter')
    ];
    let localPermissions = {};

    async function openPermissionModal() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      try {
        const [friendsRes, permsRes] = await Promise.all([
          fetch(`http://localhost:3000/api/show-friends/${folderId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch(`http://localhost:3000/api/folders/${folderId}/friends/permissions`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);
        const friendsData = await friendsRes.json();
        const permsData = await permsRes.json();
        const friendsList = friendsData.friends || [];
        const permsMap = {};
        (permsData.friends || []).forEach(f => {
          permsMap[f.username] = f.permissions;
        });
        localPermissions = {};
        let tableHtml = `<table class="table is-fullwidth"><thead><tr><th>Friend</th><th>Download</th><th>Upload</th><th>Delete</th><th>Add Users</th></tr></thead><tbody>`;
        friendsList.forEach(username => {
          const p = permsMap[username] || { download: false, upload: false, delete: false, addUsers: false };
          localPermissions[username] = { ...p };
          tableHtml += `
            <tr>
              <td>${username}</td>
              <td><button class="button is-small permission-toggle" data-username="${username}" data-perm="download">${p.download ? '✅' : '❌'}</button></td>
              <td><button class="button is-small permission-toggle" data-username="${username}" data-perm="upload">${p.upload ? '✅' : '❌'}</button></td>
              <td><button class="button is-small permission-toggle" data-username="${username}" data-perm="delete">${p.delete ? '✅' : '❌'}</button></td>
              <td><button class="button is-small permission-toggle" data-username="${username}" data-perm="addUsers">${p.addUsers ? '✅' : '❌'}</button></td>
            </tr>`;
        });
        tableHtml += `</tbody></table>`;
        permissionModalBody.innerHTML = tableHtml;
        permissionModalBody.querySelectorAll('.permission-toggle').forEach(btn => {
          btn.addEventListener('click', () => {
            const user = btn.dataset.username;
            const perm = btn.dataset.perm;
            localPermissions[user][perm] = !localPermissions[user][perm];
            btn.textContent = localPermissions[user][perm] ? '✅' : '❌';
          });
        });
        permissionModal.classList.add('is-active');
      } catch (err) {
        console.error('Error loading permissions', err);
        showNotification('Failed to load permissions', 'is-danger');
      }
    }

    function closePermissionModal() {
      permissionModal.classList.remove('is-active');
    }

    async function savePermissions() {
      const token = localStorage.getItem('jwtToken');
      if (!token) return window.location.href = '/index.html';
      try {
        savePermissionsButton.classList.add('is-loading');
        for (const username in localPermissions) {
          const body = localPermissions[username];
          await fetch(`http://localhost:3000/api/folders/${folderId}/friends/${encodeURIComponent(username)}/permissions`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
          });
        }
        savePermissionsButton.classList.remove('is-loading');
        permissionModal.classList.remove('is-active');
        showNotification('Permissions updated successfully');
      } catch (err) {
        console.error('Error saving permissions', err);
        savePermissionsButton.classList.remove('is-loading');
        showNotification('Failed to save permissions', 'is-danger');
      }
    }

    closePermissionModalButtons.forEach(btn => btn.addEventListener('click', closePermissionModal));
    document.getElementById('changePermissionButton').addEventListener('click', openPermissionModal);
    savePermissionsButton.addEventListener('click', savePermissions);

    // Initial load
    fetchFolderContents();
  </script>
</body>

</html>
